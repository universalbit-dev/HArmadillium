# =====================================================================
# File: default.conf
# Description:
# This Apache configuration is part of a high-availability cluster setup
# for the 'HArmadillium' project. It includes:
# - HTTP to HTTPS redirection (ports 80 and 8001).
# - Load balancing for WebSocket connections using multiple upstream servers.
# - HTTPS configuration, including SSL certificates and proxy settings.
# - Timeout and header settings for WebSocket support.
# - Enhanced with HTTP/2 for better performance and efficiency.
# Server: armadillium03
# =====================================================================

# HTTP to HTTPS redirection on port 80
<VirtualHost *:80>
    ServerName armadillium03
    Redirect permanent / https://armadillium03/
</VirtualHost>

# HTTP to HTTPS redirection on port 8001
Listen 8001
<VirtualHost *:8001>
    ServerName armadillium03
    Redirect permanent / https://armadillium03/
</VirtualHost>

# Load balancing for WebSocket connections
<Proxy "balancer://websocket">
    BalancerMember "http://192.168.1.141"
    BalancerMember "http://192.168.1.142"
    BalancerMember "http://192.168.1.143"
    BalancerMember "http://192.168.1.144"
</Proxy>

# HTTPS configuration
<VirtualHost *:443>
    ServerName armadillium03
    DocumentRoot "/usr/share/nginx/html"

    SSLEngine on
    SSLCertificateFile "/etc/nginx/ssl/host.cert"
    SSLCertificateKeyFile "/etc/nginx/ssl/host.key"

    # WebSocket proxy settings
    <Location />
        ProxyPass "balancer://websocket/"
        ProxyPassReverse "balancer://websocket/"
        ProxyPreserveHost On

        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
        RequestHeader set Host "%{HTTP_HOST}s"
        RequestHeader set X-Forwarded-For "%{HTTP_X_FORWARDED_FOR}s"
        RequestHeader set X-NginX-Proxy true

        ProxyAddHeaders On
        ProxyTimeout 86400
        Header always set Connection "upgrade"
        Header always set Upgrade "%{HTTP_UPGRADE}s"
    </Location>
</VirtualHost>
